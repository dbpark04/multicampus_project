# 전처리 결과 파일 구조 설명

전처리 파이프라인 실행 후 생성되는 파일들의 구조를 설명합니다.

---

## 1. processed\_{카테고리}\_with_text.json

**위치**: `data/processed_data/{카테고리별경로}/processed_{카테고리명}_with_text.json`

**설명**: 텍스트 리뷰가 있는 상품들의 전처리 결과 (벡터화 완료)

### 구조

```json
{
  "search_name": "선스틱",                    // 검색어/카테고리명
  "total_collected_reviews": 23184,          // 수집된 총 리뷰 수
  "total_text_reviews": 23184,               // 텍스트가 있는 리뷰 수
  "total_product": 114,                      // 상품 수
  "total_rating_distribution": {             // 전체 별점 분포
    "5": 16244,
    "4": 3766,
    "3": 1598,
    "2": 649,
    "1": 927
  },
  "category_sentiment_analysis": {           // 카테고리 전체 감성 분석
    "positive_special": [                    // 긍정 특수 키워드
      {
        "word": "잘쓰다",                     // 단어
        "diff": 0.0991,                      // TF-IDF 차이
        "pos": 0.1348,                       // 긍정 리뷰 비율
        "neg": 0.0357,                       // 부정 리뷰 비율
        "pos_n": 527,                        // 긍정 리뷰 출현 횟수
        "neg_n": 1,                          // 부정 리뷰 출현 횟수
        "support": 528,                      // 총 출현 횟수
        "score": 0.6216                      // 중요도 점수
      }
      // ... 더 많은 키워드
    ],
    "negative_special": [                    // 부정 특수 키워드
      {
        "word": "끈",
        "diff": -0.0512,
        // ...
      }
    ],
    "review_count": 23184,                   // 분석 대상 리뷰 수
    "pos_count": 19821,                      // 긍정 리뷰 수
    "neg_count": 1363,                       // 부정 리뷰 수
    "tfidf_notna_count": 23184               // TF-IDF 계산된 리뷰 수
  },
  "data": [                                  // 상품 리스트
    {
      "product_info": {
        "product_id": "선스틱_with_1",        // 고유 상품 ID (카테고리_with_번호)
        "original_product_id": 1,            // 원본 ID
        "category_file": "선스틱",            // 카테고리 파일명
        "brand": "tocobo",                   // 브랜드 (표준화됨)
        "category_path": "쿠팡 홈 > 뷰티 > 선케어/태닝 > 선케어 > 선스틱",
        "product_name": "[보송 선스틱] 토코보 코튼 소프트 선스틱 19g SPF50+ PA++++, 1개",
        "price": 13930,
        "delivery_type": "일반배송",
        "total_reviews": 277,
        "product_url": "https://www.coupang.com/vp/products/...",
        "rating_distribution": {             // 상품별 별점 분포
          "5": 213,
          "4": 32,
          "3": 12,
          "2": 5,
          "1": 15
        },
        "category_normal": "선스틱",          // 정규화된 카테고리
        "product_name_clean": "토코보 코튼 소프트 선스틱",  // 정제된 상품명
        "product_tokens": ["토코보", "코튼", "소프트", "선스틱"],
        "skin_type": "건성",                  // 자동 분류된 피부 타입

        // ===== VECTORIZER_TYPE = "both" 일 때 =====
        "product_vector_word2vec": [0.123, -0.456, ...],     // 100차원 Word2Vec 상품 벡터
        "representative_review_id_word2vec": "12345",        // Word2Vec 기반 대표 리뷰 ID
        "representative_similarity_word2vec": 0.95,          // Word2Vec 유사도
        "product_vector_bert": [0.789, -0.234, ...],         // 768차원 BERT 상품 벡터
        "representative_review_id_bert": "12346",            // BERT 기반 대표 리뷰 ID
        "representative_similarity_bert": 0.92,              // BERT 유사도

        // ===== VECTORIZER_TYPE = "word2vec" 또는 "bert" 일 때 =====
        "product_vector": [0.123, -0.456, ...],              // 단일 벡터
        "representative_review_id": "12345",                 // 대표 리뷰 ID
        "representative_similarity": 0.95,                   // 유사도

        "sentiment_analysis": {              // 상품별 감성 분석
          "positive_special": [...],         // 긍정 키워드
          "negative_special": [...],         // 부정 키워드
          "review_count": 187,
          "pos_count": 165,
          "neg_count": 10
        }
      }
      //  reviews 데이터는 with_text.json에 포함되지 않음 (Parquet에만 저장)
    }
  ]
}
```

### 주요 특징

- **벡터화 완료**: 상품별 대표 벡터 포함
- **감성 분석 완료**: 카테고리 및 상품별 감성 키워드
- **피부 타입 분류**: 자동으로 피부 타입 추론
- **리뷰 텍스트 미포함**: 리뷰 상세 정보는 Parquet 파일에만 저장

---

## 2. processed\_{카테고리}\_without_text.json

**위치**: `data/processed_data/{카테고리별경로}/processed_{카테고리명}_without_text.json`

**설명**: 텍스트 리뷰가 없는 상품들 (벡터화 불가)

### 구조

```json
{
  "search_name": "선스틱",
  "total_collected_reviews": 16448,          // 수집된 총 리뷰 수
  "total_text_reviews": 0,                   // 텍스트가 있는 리뷰 수 (0)
  "total_product": 119,                      // 상품 수
  "total_rating_distribution": {
    "5": 7794,
    "4": 4511,
    "3": 2351,
    "2": 1163,
    "1": 629
  },
  "data": [
    {
      "product_info": {
        "product_id": "선스틱_without_1",    // 고유 상품 ID (카테고리_without_번호)
        "original_product_id": 1,
        "category_file": "선스틱",
        "brand": "tocobo",
        "category_path": "...",
        "product_name": "...",
        "price": 13930,
        // ... (with_text와 동일한 기본 정보)

        //  벡터화 관련 필드 없음 (리뷰가 없어서)
        //  감성 분석 없음
        //  피부 타입 없음
      },
      "reviews": {
        "total_count": 187,
        "text_count": 0,                     // 텍스트 리뷰 수 = 0
        "data": [
          {
            "id": 36,
            "score": 5,
            "date": "2025-11-22",
            "collected_at": "2025-12-20 14:13:34",
            "nickname": null,
            "has_image": false,
            "helpful_count": 0,
            "full_text": null                // 텍스트 없음
          }
          // ...
        ]
      }
    }
  ]
}
```

### 주요 특징

- **벡터화 없음**: 텍스트가 없어서 벡터 생성 불가
- **감성 분석 없음**: 텍스트 분석 불가
- **기본 정보 포함**: 상품명, 가격, 별점 분포 등
- **리뷰 메타데이터 포함**: 별점, 날짜, 이미지 여부 등

---

## 3. integrated_products_vector.parquet

**위치**: `data/processed_data/integrated_products_vector.parquet`

**설명**: 모든 카테고리의 상품 정보를 통합한 Parquet 파일 (with_text만 포함)

### 컬럼 구조 (22개 컬럼)

```python
[
    'product_id',                          # str: "선스틱_with_1"
    'brand',                               # str: "tocobo"
    'category_path',                       # str: 카테고리 경로
    'product_name',                        # str: 전체 상품명
    'price',                               # int: 가격
    'delivery_type',                       # str: 배송 타입
    'total_reviews',                       # int: 총 리뷰 수
    'product_url',                         # str: 상품 URL
    'rating_distribution',                 # dict: 별점 분포
    'category_normal',                     # str: 정규화된 카테고리
    'product_name_clean',                  # str: 정제된 상품명
    'product_tokens',                      # list[str]: 토큰화된 상품명
    'original_product_id',                 # int: 원본 ID
    'category_file',                       # str: 카테고리 파일명
    'skin_type',                           # str: 피부 타입 ("건성", "지성", ...)

    # VECTORIZER_TYPE = "both" 일 때
    'product_vector_word2vec',             # list[float]: 100차원 벡터
    'representative_review_id_word2vec',   # str: 대표 리뷰 ID
    'representative_similarity_word2vec',  # float: 유사도 (0~1)
    'product_vector_bert',                 # list[float]: 768차원 벡터
    'representative_review_id_bert',       # str: 대표 리뷰 ID
    'representative_similarity_bert',      # float: 유사도 (0~1)

    'sentiment_analysis'                   # dict: 상품별 감성 분석 결과
]
```

### 데이터 크기

- **행 수**: 466개 (텍스트 리뷰가 있는 상품만)
- **컬럼 수**: 22개

### 사용 예시

```python
import pandas as pd

# 파일 로드
df = pd.read_parquet('data/processed_data/integrated_products_vector.parquet')

# 특정 카테고리 필터링
sunstick_products = df[df['category_file'] == '선스틱']

# Word2Vec 벡터 추출
vectors = df['product_vector_word2vec'].tolist()

# BERT 벡터 추출
bert_vectors = df['product_vector_bert'].tolist()

# 건성 피부 추천 상품
dry_skin_products = df[df['skin_type'] == '건성']
```

---

## 4. integrated_reviews_detail.parquet

**위치**: `data/processed_data/integrated_reviews_detail.parquet`

**설명**: 모든 리뷰의 상세 정보 및 벡터를 통합한 Parquet 파일

### 컬럼 구조 (14개 컬럼)

```python
[
    'product_id',         # str: "선스틱_with_1" (어떤 상품의 리뷰인지)
    'review_id',          # str: 리뷰 고유 ID
    'full_text',          # str: 리뷰 전문
    'score',              # int: 별점 (1~5)
    'label',              # int: 감성 라벨 (1=긍정, 0=부정, None=중립)
    'tokens',             # list[str]: 토큰화된 리뷰 텍스트
    'char_length',        # int: 원문 글자 수
    'token_count',        # int: 토큰 개수
    'date',               # str: 작성 날짜 "YYYY-MM-DD"
    'nickname',           # str: 작성자 닉네임
    'has_image',          # bool: 이미지 포함 여부
    'helpful_count',      # int: 도움이 됐어요 수

    # VECTORIZER_TYPE = "word2vec" 또는 "both"
    'word2vec',           # list[float]: 100차원 Word2Vec 벡터

    # VECTORIZER_TYPE = "bert" 또는 "both"
    'bert'                # list[float]: 768차원 BERT 벡터
]
```

### 데이터 크기

- **행 수**: 68,720개 (전체 텍스트 리뷰)
- **컬럼 수**: 14개

### 벡터 값 예시

```python
# VECTORIZER_TYPE = "both" 일 때
{
    "product_id": "선스틱_with_1",
    "review_id": "12345",
    "full_text": "흡수가 빠르고 촉촉해요",
    "score": 5,
    "label": 1,  # 긍정
    "tokens": ["흡수", "빠르다", "촉촉하다"],
    "char_length": 15,
    "token_count": 3,
    "word2vec": [0.123, -0.456, 0.789, ...],  # 100개 값
    "bert": [0.234, -0.567, 0.891, ...]       # 768개 값
}

# VECTORIZER_TYPE = "word2vec" 일 때
{
    ...
    "word2vec": [0.123, -0.456, ...],
    "bert": None
}

# VECTORIZER_TYPE = "bert" 일 때
{
    ...
    "word2vec": None,
    "bert": [0.234, -0.567, ...]
}
```

### 사용 예시

```python
import pandas as pd
import numpy as np

# 파일 로드
df = pd.read_parquet('data/processed_data/integrated_reviews_detail.parquet')

# 특정 상품의 리뷰 필터링
product_reviews = df[df['product_id'] == '선스틱_with_1']

# 긍정 리뷰만 추출
positive_reviews = df[df['label'] == 1]

# Word2Vec 벡터로 유사 리뷰 검색
def find_similar_reviews(target_vector, df, top_k=5):
    vectors = np.array(df['word2vec'].tolist())
    similarities = np.dot(vectors, target_vector)
    top_indices = np.argsort(similarities)[-top_k:]
    return df.iloc[top_indices]

# BERT 벡터로 감성 분류 모델 학습
X = np.array(df['bert'].tolist())
y = df['label'].values
# 머신러닝 모델 학습...
```

---

## 5. integrated_products_vector_metadata.json

**위치**: `data/processed_data/integrated_products_vector_metadata.json`

**설명**: 전체 데이터셋의 메타데이터 및 전역 감성 분석 결과

### 구조

```json
{
  "skin_type_word_frequency": {           // 피부 타입별 자주 나오는 단어
    "건성": [
      {
        "word": "피부",
        "count": 8758
      },
      {
        "word": "바르다",
        "count": 7141
      },
      {
        "word": "좋다",
        "count": 5859
      }
      // ... 상위 20개
    ],
    "지성": [...],
    "복합성": [...],
    "중성": [...],
    "민감성": [...]
  },
  "overall_sentiment_special_words": {    // 전체 데이터셋 감성 키워드
    "positive_special": [
      {
        "word": "좋다",
        "diff": 0.123,
        "pos": 0.456,
        "neg": 0.333,
        "pos_n": 12345,
        "neg_n": 678,
        "support": 13023,
        "score": 0.789
      }
      // ... 상위 30개
    ],
    "negative_special": [
      {
        "word": "끈",
        "diff": -0.087,
        // ...
      }
      // ... 상위 30개
    ],
    "review_count": 68720,                // 전체 리뷰 수
    "pos_count": 58234,                   // 긍정 리뷰 수
    "neg_count": 4562,                    // 부정 리뷰 수
    "tfidf_notna_count": 68720            // TF-IDF 계산된 리뷰 수
  }
}
```

### 주요 특징

- **피부 타입별 분석**: 각 피부 타입에서 자주 언급되는 단어 Top 20
- **전역 감성 키워드**: 전체 데이터셋에서 긍정/부정을 특징짓는 단어
- **통계 정보**: 전체 리뷰 수, 감성 분포

### 사용 예시

```python
import json

# 메타데이터 로드
with open('data/processed_data/integrated_products_vector_metadata.json', 'r') as f:
    metadata = json.load(f)

# 건성 피부에서 자주 나오는 단어
dry_skin_words = metadata['skin_type_word_frequency']['건성']
print(f"건성 피부 Top 단어: {dry_skin_words[0]['word']}")

# 전체 긍정 키워드
positive_keywords = metadata['overall_sentiment_special_words']['positive_special']
top_positive = positive_keywords[0]['word']
print(f"가장 긍정적인 단어: {top_positive}")
```

---

## 6. basic_stats_summary.json (선택적)

**위치**: `data/processed_data/eda_outputs/basic_stats_summary.json`

**설명**: EDA 실행 시 생성되는 기본 통계 요약 (save_summary_json=True일 때)

### 구조

```json
{
  "meta": {
    "n_files": 8,                         // 분석한 파일 수
    "total_reviews_collected": 68720,    // 수집된 총 리뷰 수
    "total_products_seen": 466,          // 분석한 상품 수
    "file_read_error": 0,
    "missing_product_id": 0,
    "invalid_score": 0
  },
  "category_product_counts": {            // 카테고리별 상품 수
    "선스틱": 114,
    "선스프레이": 89,
    "선케어_선크림_선로션": 145,
    "선쿠션_선팩트": 118
  },
  "product_review_count_summary": {       // 상품별 리뷰 수 통계
    "count": 466,
    "mean": 147.5,
    "std": 89.3,
    "min": 10,
    "25%": 87,
    "50%": 132,
    "75%": 189,
    "max": 523
  },
  "score_distribution": {                 // 전체 별점 분포
    "1": 2543,
    "2": 4321,
    "3": 8765,
    "4": 19876,
    "5": 33215
  },
  "category_score_summary": {             // 카테고리별 평균 별점
    "선스틱": {
      "total_cnt": 23184,
      "mean_score": 4.56
    },
    "선스프레이": {
      "total_cnt": 15678,
      "mean_score": 4.42
    }
    // ...
  }
}
```

### 생성 조건

```python
# src/EDA/basic_statistics_eda.py 설정
@dataclass(frozen=True)
class BasicStatsConfig:
    save_summary_json: bool = True        # True로 설정해야 생성됨
    summary_json_name: str = "basic_stats_summary.json"
```

---

## 파일 간 관계도

```
전처리 파이프라인 실행
        ↓
┌───────────────────────────────────────────────┐
│ 카테고리별 JSON 파일 생성                      │
├───────────────────────────────────────────────┤
│ • processed_선스틱_with_text.json             │
│ • processed_선스틱_without_text.json          │
│ • processed_선스프레이_with_text.json         │
│ • processed_선스프레이_without_text.json      │
│ • ...                                         │
└───────────────────────────────────────────────┘
        ↓
┌───────────────────────────────────────────────┐
│ 통합 Parquet 파일 생성                        │
├───────────────────────────────────────────────┤
│ • integrated_products_vector.parquet          │
│   (with_text 상품만 통합)                     │
│ • integrated_reviews_detail.parquet           │
│   (모든 리뷰 통합)                            │
│ • integrated_products_vector_metadata.json    │
│   (전역 메타데이터)                           │
└───────────────────────────────────────────────┘
        ↓
┌───────────────────────────────────────────────┐
│ EDA 실행 (선택적)                             │
├───────────────────────────────────────────────┤
│ • basic_stats_summary.json                    │
│ • 기타 통계 파일들 (parquet/csv)              │
└───────────────────────────────────────────────┘
```

---

## 파일 선택 가이드

### 분석 목적별 추천 파일

| 목적             | 추천 파일                                  | 이유                            |
| ---------------- | ------------------------------------------ | ------------------------------- |
| 상품 추천 시스템 | `integrated_products_vector.parquet`       | 상품 벡터로 유사도 계산 가능    |
| 리뷰 검색        | `integrated_reviews_detail.parquet`        | 리뷰 벡터로 시맨틱 검색 가능    |
| 감성 분석        | `integrated_reviews_detail.parquet`        | label 컬럼으로 학습 데이터 구축 |
| 통계 분석        | `basic_stats_summary.json`                 | 전체 통계 요약                  |
| 피부 타입별 분석 | `integrated_products_vector_metadata.json` | 피부 타입별 키워드              |
| 카테고리별 분석  | `processed_*_with_text.json`               | 카테고리 감성 키워드 포함       |

### 벡터화 방법별 컬럼

| VECTORIZER_TYPE | product 벡터 컬럼                                                      | review 벡터 컬럼                         |
| --------------- | ---------------------------------------------------------------------- | ---------------------------------------- |
| "word2vec"      | `product_vector` (100차원)                                             | `word2vec` (100차원)                     |
| "bert"          | `product_vector` (768차원)                                             | `bert` (768차원)                         |
| "both"          | `product_vector_word2vec` (100차원)<br>`product_vector_bert` (768차원) | `word2vec` (100차원)<br>`bert` (768차원) |

---

## 주의사항

1. **without_text 파일**: 벡터화되지 않았으므로 머신러닝 모델에 사용 불가
2. **Parquet 파일 크기**: 벡터 데이터로 인해 용량이 큼 (압축 권장)
3. **메모리 사용**: BERT 벡터(768차원)는 Word2Vec(100차원)보다 7배 이상 메모리 사용
4. **대표 리뷰**: "both" 모드에서는 Word2Vec과 BERT의 대표 리뷰가 다를 수 있음

---

## 버전 정보

- 생성 날짜: 2025-12-29
- 전처리 파이프라인 버전: 2.0
- 지원 벡터화 방법: Word2Vec, BERT, Both
